{% load static %}
<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}
        КМ/Ч 120
      {% endblock %}
    </title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="container-top">
          <div class="lang-selector">
            <span>Українська</span>
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="working-hours">
            <span>Працюємо: Пн-Пт 9:00-18:00</span>
          </div>
        </div>
      </div>

      <!-- Main Nav -->
      <div class="main-nav">
        <a href="{% url 'catalog:index' %}" class="logo">
          <div class="logo-container">
            <span class="logo-top">КМ/Ч</span>
            <span class="logo-bottom">120</span>
          </div>
        </a>

        <nav class="nav-links">
          <a href="{% url 'catalog:tire_list' %}" class="nav-link">Шини</a>
          <a href="{% url 'catalog:disk_list' %}" class="nav-link">Диски</a>
          <a href="{% url 'catalog:calculator' %}" class="nav-link nav-link-accent">Калькулятор</a>
          <a href="{% url 'catalog:pre_order' %}" class="nav-link">Попереднє замовлення</a>
          <a href="{% url 'catalog:delivery' %}" class="nav-link">Оплата і доставка</a>
          <a href="{% url 'catalog:contacts' %}" class="nav-link">Контакти</a>
          <a href="{% url 'catalog:about' %}" class="nav-link">Про нас</a>
        </nav>

        <div class="header-actions">
          <div class="search-wrapper">
            <button class="icon-btn search-toggle" aria-label="Пошук" onclick="toggleSearch()">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </button>
            <div class="search-dropdown" id="searchDropdown">
              <form action="{% url 'catalog:search' %}" method="get" class="search-form-header">
                <input
                  type="text"
                  name="q"
                  placeholder="Пошук шин та дисків..."
                  class="search-input-header"
                  id="searchInput"
                />
                <button type="submit" class="search-submit-header">
                  <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                </button>
              </form>
            </div>
          </div>

          <a href="{% url 'catalog:cart' %}" class="cart-btn">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg>
            <span class="cart-badge" id="cartBadge">0</span>
          </a>

          <button class="callback-btn" onclick="openCallbackModal()">
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>Передзвоніть мені
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    {% block content %}

    {% endblock %}

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-grid">
          <div class="footer-col">
            <a href="{% url 'catalog:index' %}" class="logo">
              <div class="logo-container">
                <span class="logo-top-footer">КМ/Ч</span>
                <span class="logo-bottom-footer">120</span>
              </div>
            </a>
            <p class="footer-copyright">120.com.ua &copy; 2026</p>
          </div>

          <div class="footer-col">
            <a href="{% url 'catalog:about' %}" class="footer-link">Про нас</a>
            <a href="{% url 'catalog:delivery' %}" class="footer-link">Оплата та доставка</a>
            <a href="{% url 'catalog:pre_order' %}" class="footer-link">Гарантія та повернення</a>
            <a href="{% url 'catalog:contacts' %}" class="footer-link">Контакти</a>
          </div>

          <div class="footer-contacts">
            <div class="footer-phones">
              <a href="tel:+380963870223" class="footer-phone">+38 (096) 38-70-223</a>
              <a href="tel:+380508572399" class="footer-phone">+38 (050) 857-23-99</a>
            </div>
            <button class="callback-btn-footer" onclick="openCallbackModal()">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>Передзвоніть мені
            </button>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="container">
          <div class="footer-bottom-content">
            <span>Політика конфіденційності</span>
            <span>Розробка сайту - KMH 120 Team</span>
          </div>
        </div>
      </div>
    </footer>

    <!-- One Click Buy Modal -->
    <div class="modal-overlay" id="oneClickModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Купити в 1 клік</h3>
          <button class="modal-close" onclick="closeOneClickModal()">&times;</button>
        </div>
        <div class="modal-product-info" id="oneClickProductInfo">
          <!-- Product info will be inserted here -->
        </div>
        <form id="oneClickForm" class="modal-form">
          <input type="hidden" id="oneClickType" name="type">
          <input type="hidden" id="oneClickProductId" name="product_id">
          <div class="form-group">
            <label for="oneClickPhone">Телефон <span class="required">*</span></label>
            <input type="tel" id="oneClickPhone" name="phone" required placeholder="+38 (___) ___-__-__">
          </div>
          <p class="modal-hint">Введіть номер телефону і ми зателефонуємо вам для підтвердження замовлення</p>
          <button type="submit" class="modal-submit">Замовити</button>
        </form>
      </div>
    </div>

    <!-- Callback Modal -->
    <div class="modal-overlay" id="callbackModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Замовити дзвінок</h3>
          <button class="modal-close" onclick="closeCallbackModal()">&times;</button>
        </div>
        <form id="callbackForm" class="modal-form">
          <div class="form-group">
            <label for="callbackName">Ім'я <span class="required">*</span></label>
            <input type="text" id="callbackName" name="name" required placeholder="Введіть ваше ім'я">
          </div>
          <div class="form-group">
            <label for="callbackPhone">Телефон <span class="required">*</span></label>
            <input type="tel" id="callbackPhone" name="phone" required placeholder="+38 (___) ___-__-__">
          </div>
          <div class="form-group">
            <label for="callbackQuestion">Питання</label>
            <textarea id="callbackQuestion" name="question" rows="3" placeholder="Опишіть ваше питання (необов'язково)"></textarea>
          </div>
          <button type="submit" class="modal-submit">Надіслати</button>
        </form>
      </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
      function toggleSearch() {
        const dropdown = document.getElementById('searchDropdown');
        const input = document.getElementById('searchInput');
        dropdown.classList.toggle('active');
        if (dropdown.classList.contains('active')) {
          input.focus();
        }
      }

      // Close search when clicking outside
      document.addEventListener('click', function(e) {
        const wrapper = document.querySelector('.search-wrapper');
        const dropdown = document.getElementById('searchDropdown');
        if (wrapper && !wrapper.contains(e.target) && dropdown.classList.contains('active')) {
          dropdown.classList.remove('active');
        }
      });

      // Close search on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const dropdown = document.getElementById('searchDropdown');
          if (dropdown.classList.contains('active')) {
            dropdown.classList.remove('active');
          }
        }
      });

      // Toast notification
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => { toast.className = 'toast'; }, 3000);
      }

      // Update cart badge
      function updateCartBadge(count) {
        const badge = document.getElementById('cartBadge');
        if (badge) {
          badge.textContent = count;
          badge.style.display = count > 0 ? 'flex' : 'none';
        }
      }

      // Add to cart function
      function addToCart(type, id, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        fetch('{% url "catalog:cart_add" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ type: type, id: id, quantity: 1 })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, 'success');
            updateCartBadge(data.cart_count);
          } else {
            showToast(data.error || 'Помилка', 'error');
          }
        })
        .catch(err => {
          showToast('Помилка з\'єднання', 'error');
        });
      }

      // Load cart count on page load
      document.addEventListener('DOMContentLoaded', function() {
        fetch('{% url "catalog:cart_count" %}')
          .then(r => r.json())
          .then(data => updateCartBadge(data.count));
      });

      // One Click Buy Modal functions
      function openOneClickModal(type, productId, productName, productPrice) {
        document.getElementById('oneClickType').value = type;
        document.getElementById('oneClickProductId').value = productId;
        document.getElementById('oneClickProductInfo').innerHTML = `
          <div class="modal-product-name">${productName}</div>
          <div class="modal-product-price">${productPrice} ₴</div>
        `;
        document.getElementById('oneClickModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        document.getElementById('oneClickPhone').focus();
      }

      function closeOneClickModal() {
        document.getElementById('oneClickModal').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('oneClickForm').reset();
      }

      // Close one click modal on overlay click
      document.getElementById('oneClickModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeOneClickModal();
        }
      });

      // Handle one click form submission
      document.getElementById('oneClickForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const type = document.getElementById('oneClickType').value;
        const productId = document.getElementById('oneClickProductId').value;
        const phone = document.getElementById('oneClickPhone').value.trim();

        if (!phone) {
          showToast('Введіть номер телефону', 'error');
          return;
        }

        const submitBtn = this.querySelector('.modal-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Оформлюємо...';

        fetch('{% url "catalog:one_click_order" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ type: type, product_id: productId, phone: phone })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, 'success');
            closeOneClickModal();
          } else {
            showToast(data.error || 'Помилка оформлення', 'error');
          }
        })
        .catch(err => {
          showToast('Помилка з\'єднання', 'error');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Замовити';
        });
      });

      // Callback Modal functions
      function openCallbackModal() {
        document.getElementById('callbackModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeCallbackModal() {
        document.getElementById('callbackModal').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('callbackForm').reset();
      }

      // Close modal on overlay click
      document.getElementById('callbackModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeCallbackModal();
        }
      });

      // Close modals on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const callbackModal = document.getElementById('callbackModal');
          const oneClickModal = document.getElementById('oneClickModal');
          if (callbackModal.classList.contains('active')) {
            closeCallbackModal();
          }
          if (oneClickModal.classList.contains('active')) {
            closeOneClickModal();
          }
        }
      });

      // Handle callback form submission
      document.getElementById('callbackForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const name = document.getElementById('callbackName').value.trim();
        const phone = document.getElementById('callbackPhone').value.trim();
        const question = document.getElementById('callbackQuestion').value.trim();

        if (!name || !phone) {
          showToast('Заповніть обов\'язкові поля', 'error');
          return;
        }

        const submitBtn = this.querySelector('.modal-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Надсилаємо...';

        fetch('{% url "catalog:callback_request" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ name: name, phone: phone, question: question })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, 'success');
            closeCallbackModal();
          } else {
            showToast(data.error || 'Помилка відправки', 'error');
          }
        })
        .catch(err => {
          showToast('Помилка з\'єднання', 'error');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Надіслати';
        });
      });
    </script>
  </body>
</html>
